<div class="app-container">
  <header class="app-header">
    <h1>ü§ñ Agent Event Viewer</h1>
    <div class="header-right">
      <div class="api-url-container">
        @if (!editingApiUrl()) {
          <div class="api-url-display" (click)="startEditingApiUrl()" title="Click to edit API URL">
            <span class="api-url-label">API:</span>
            <code class="api-url-value">{{ getApiUrl() }}</code>
            <span class="edit-icon">‚úèÔ∏è</span>
          </div>
        } @else {
          <div class="api-url-editor">
            <input
              type="text"
              class="api-url-input"
              [(ngModel)]="tempApiUrl"
              placeholder="http://localhost:3000"
              (keydown.enter)="saveApiUrl()"
              (keydown.escape)="cancelEditApiUrl()"
              autofocus
            />
            <button class="btn-save" (click)="saveApiUrl()" title="Save">‚úì</button>
            <button class="btn-cancel" (click)="cancelEditApiUrl()" title="Cancel">‚úï</button>
          </div>
        }
      </div>
      <div class="header-stats">
        <span class="stat">{{ sessions().length }} Sessions</span>
        @if (selectedSession()) {
          <span class="stat">{{ selectedSession()!.events.length }} Events</span>
        }
      </div>
    </div>
  </header>

  <div class="main-content">
    <!-- Left Sidebar: Session List -->
    <aside class="session-list">
      <div class="session-list-header">
        <h2>Sessions</h2>
        @if (loading()) {
          <div class="loading">Loading...</div>
        }
      </div>

      <div class="sessions">
        @for (session of sessions(); track session.sessionId) {
          <div
            class="session-item"
            [class.active]="selectedSession()?.sessionId === session.sessionId"
            (click)="selectSession(session)">
            <div class="session-header">
              <span class="session-id">{{ getShortId(session.sessionId) }}</span>
              <span class="session-time">{{ formatTime(session.startTime) }}</span>
            </div>
            <div class="session-meta">
              <span class="event-count">{{ session.events.length }} events</span>
              <span class="session-date">{{ formatDate(session.startTime) }}</span>
            </div>
          </div>
        } @empty {
          @if (!loading()) {
            <div class="empty-state">No sessions found</div>
          }
        }
      </div>
    </aside>

    <!-- Right Panel: Event Flow -->
    <main class="event-panel">
      @if (selectedSession()) {
        <div class="event-panel-header">
          <h2>Session Events</h2>
          <div class="session-info">
            <span class="info-label">Session ID:</span>
            <code class="session-id-full">{{ selectedSession()!.sessionId }}</code>
          </div>
        </div>

        <div class="events-timeline">
          @for (entry of selectedSession()!.events; track entry.filename; let i = $index) {
            <div class="event-card" [attr.data-event-type]="entry.content.hookName">
              <div class="event-header">
                <span class="event-number">{{ i + 1 }}</span>
                <span class="event-type" [class]="'event-type-' + entry.content.hookName">
                  {{ entry.content.hookName }}
                </span>
                <span class="event-time">{{ formatEventTime(entry.content.isoTimestamp) }}</span>
              </div>

              <div class="event-body">
                @switch (entry.content.hookName) {
                  @case ('sessionStart') {
                    <div class="event-detail">
                      <strong>Session Started</strong>
                      <div class="detail-row">
                        <span class="label">Source:</span>
                        <span>{{ entry.content.input.source }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="label">Working Directory:</span>
                        <code>{{ entry.content.input.cwd }}</code>
                      </div>
                    </div>
                  }
                  @case ('userPromptSubmitted') {
                    <div class="event-detail">
                      <strong>User Prompt</strong>
                      <div class="prompt-text">{{ entry.content.input.prompt }}</div>
                    </div>
                  }
                  @case ('preToolUse') {
                    <div class="event-detail">
                      <strong>Tool: {{ entry.content.input.tool_name }}</strong>
                      <div class="detail-row">
                        <span class="label">Goal:</span>
                        <span>{{ entry.content.input.tool_input?.goal }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="label">Explanation:</span>
                        <span>{{ entry.content.input.tool_input?.explanation }}</span>
                      </div>
                      @if (entry.content.input.tool_input?.command) {
                        <div class="detail-row">
                          <span class="label">Command:</span>
                          <code class="command">{{ entry.content.input.tool_input.command }}</code>
                        </div>
                      }
                      @if (entry.content.input.tool_input?.['filePath']) {
                        <div class="detail-row">
                          <span class="label">File:</span>
                          <code>{{ entry.content.input.tool_input['filePath'] }}</code>
                        </div>
                      }
                    </div>
                  }
                  @case ('postToolUse') {
                    <div class="event-detail">
                      <strong>Tool Result: {{ entry.content.input.tool_name }}</strong>
                      @if (entry.content.input.tool_response) {
                        <div class="tool-response">
                          <pre>{{ truncateResponse(entry.content.input.tool_response) }}</pre>
                        </div>
                      }
                    </div>
                  }
                  @default {
                    <div class="event-detail">
                      <strong>Unknown Event</strong>
                      <pre class="raw-data">{{ formatJson(entry.content) }}</pre>
                    </div>
                  }
                }
              </div>

              <div class="event-footer">
                <span class="filename">{{ entry.filename }}</span>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-panel">
          <div class="empty-icon">üìã</div>
          <h3>No Session Selected</h3>
          <p>Select a session from the left sidebar to view its event flow</p>
        </div>
      }
    </main>
  </div>
</div>
